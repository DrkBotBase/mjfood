<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title><%= info.name_page %></title>
  
  <meta name="description" content="<%= info.desc %>">
  <meta name="keywords" content="<%= info.keywords %>">
  <meta name="author" content="<%= info.author %>">
  <meta name="theme-color" content="<%= info.colorTheme %>">
  
  <meta name="robots" content="index, follow">
  <meta name="googlebot" content="index, follow">
  <link rel="canonical" href="<%= info.dominio %>">
  
  <meta property="og:title" content="<%= info.name_page %>">
  <meta property="og:description" content="<%= info.desc %>.">
  <meta property="og:image" content="<%= info.dominio %>/assets/<%= info.logo %>.png">
  <meta property="og:image:alt" content="<%= info.name_page %>">
  <meta property="fb:app_id" content="<%= info.fb_app_id %>">
  <meta property="og:url" content="<%= info.dominio %>">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="<%= info.name_page %>">
  <meta property="og:locale" content="es_ES">
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="<%= info.name_page %>">
  <meta name="twitter:description" content="<%= info.desc %>">
  <meta name="twitter:image" content="<%= info.dominio %>/assets/<%= info.logo %>.png">
  <meta name="twitter:image:alt" content="<%= info.name_page %>">
  
  <link rel="manifest" href="/lista/manifest.json">
  
  <link rel="icon" href="/assets/<%= info.icon %>.png" type="image/png">
  <link rel="apple-touch-icon" href="/assets/<%= info.icon %>.png">
  
  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Playfair+Display:ital,wght@0,900;1,900&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS y Font Awesome -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary-color: <%= info.colorBase.primary %>;
      --bg-color: <%= info.colorBase.bg %>;
      --text-color: <%= info.colorBase.text %>;
    }
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    .font-elegant {
      font-family: 'Playfair Display', serif;
    }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    
    #carousel-inner {
      display: flex;
      transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .carousel-item { min-width: 100%; }

    /* Estilos para el bot√≥n de like activo */
    .like-btn.like-active {
      box-shadow: 0 0 0 2px var(--primary-color);
    }

    .like-btn.like-active i {
      transform: rotate(-12deg) scale(1.1);
    }
    
    .like-count {
      transition: transform 0.15s ease;
    }
    
    .card-shadow {
        box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05);
    }
    
    @keyframes pulse-shadow {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
      }
      50% {
        box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
      }
    }
    
    .animate-pulse-shadow {
      animation: pulse-shadow 2s infinite;
    }
  </style>
</head>
<body class="antialiased pb-12">

  <!-- HEADER -->
  <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-gray-100 h-20">
    <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
      <a href="/lista" class="flex items-center gap-2">
        <span class="font-elegant text-3xl text-[var(--primary-color)] tracking-tighter">
          <%= info.name_page %>
        </span>
      </a>
      
      <div class="flex items-center gap-4">
        <div class="hidden md:flex bg-gray-100 rounded-full px-4 py-2 items-center gap-2">
            <i class="fa-solid fa-utensils text-[var(--primary-color)] text-xs"></i>
            <span class="text-xs font-bold text-gray-500 uppercase">Directorio Gourmet</span>
        </div>
        <div class="w-12 h-12 rounded-full overflow-hidden animate-pulse-shadow">
          <img src="/assets/icon.png" class="w-[130%] h-[130%] object-cover -translate-y-[13%]">
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8">
    
    <!-- SECCI√ìN DE B√öSQUEDA -->
    <div class="mb-10 max-w-3xl mx-auto">
        <form action="/lista/#restaurantes" method="GET" class="relative">
          <input type="hidden" name="sort" value="<%= currentSort %>">
          <input type="hidden" name="filter" value="<%= currentFilter %>">
          
          <div class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none">
            <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
          </div>
          <input type="text" name="search" value="<%= searchTerm %>" placeholder="Busca sabores, lugares o nombres..." 
            class="w-full py-5 pl-14 pr-32 rounded-3xl bg-white border-none shadow-xl shadow-gray-100 focus:ring-2 focus:ring-[var(--primary-color)] outline-none transition-all text-gray-700">
          
          <button type="submit" class="absolute right-2 top-2 bottom-2 bg-[var(--primary-color)] text-white px-6 rounded-2xl font-bold text-sm hover:opacity-90 transition-all">
            Buscar
          </button>
        </form>
    </div>

    <!-- CARRUSEL PUBLICITARIO -->
    <section class="mb-14 relative group overflow-hidden rounded-[2.5rem] shadow-2xl shadow-gray-200/50">
        <div id="carousel-inner">
          <% 
            const slides = [
              ...carouselAds.map(r => ({ type: 'restaurant', data: r })),
              ...promosActivas.map(p => ({ type: 'promo', data: p }))
            ];
          %>
          <% if (slides.length === 0) { %>
            <div class="carousel-item bg-gradient-to-br from-gray-700 to-gray-900 p-10 text-white">
              <h2 class="text-3xl font-black">Muy pronto nuevas promociones üöÄ</h2>
            </div>
          <% } %>
          <% slides.forEach((slide, index) => { %>
            <% if (slide.type === 'restaurant') { %>
              <!-- üÜï RESTAURANTE NUEVO -->
              <div class="carousel-item <%= index === 0 ? 'active' : '' %> bg-gradient-to-br from-orange-500 to-red-600 p-8 md:p-14 text-white">
                <div class="flex flex-col md:flex-row items-center justify-between gap-8 h-full">
                  <div class="max-w-md text-center md:text-left">
                    <span class="bg-white/20 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest mb-4 inline-block">
                      Nuevo restaurante
                    </span>
                    <h2 class="text-4xl md:text-5xl font-black mb-6 leading-tight">
                      Descubre <br>
                      <span class="text-yellow-300 italic"><%= slide.data.name %></span>
                    </h2>
                    <a href="/<%= slide.data.id %>" class="bg-white text-orange-600 px-8 py-3.5 rounded-2xl font-black shadow-xl hover:scale-105 transition">
                      VER MEN√ö
                    </a>
                  </div>
                  <img src="<%= slide.data.logo %>"
                    class="w-64 h-64 md:w-80 md:h-80 object-cover rounded-[2.5rem] shadow-2xl rotate-3"
                    alt="<%= slide.data.name %>">
                </div>
              </div>
            <% } else { %>
              <!-- üì¢ PROMOCI√ìN / PUBLICIDAD -->
              <div class="carousel-item <%= index === 0 ? 'active' : '' %> bg-gradient-to-br <%= slide.data.gradiente %> p-8 md:p-14 text-white">
                <div class="flex flex-col md:flex-row items-center justify-between gap-6 h-full">
                  <div class="max-w-md text-center md:text-left">
                    <span class="bg-white/20 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest mb-2 inline-block">
                      <%= slide.data.tag %>
                    </span>
                    <h2 class="text-2xl md:text-4xl font-black mb-6 leading-tight">
                      <%= slide.data.titulo %><br>
                      <span class="text-yellow-300"><%= slide.data.subtitulo %></span>
                    </h2>
                    <a href="<%= slide.data.url %>" class="bg-white text-indigo-600 px-8 py-3.5 rounded-2xl font-black shadow-xl hover:scale-105 transition">
                      <%= slide.data.cta %>
                    </a>
                  </div>
                  <img src="<%= slide.data.imagen %>"
                    class="w-64 h-64 md:w-80 md:h-80 object-cover rounded-[2.5rem] shadow-2xl rotate-3"
                    alt="<%= slide.data.titulo %>">
                </div>
              </div>
            <% } %>
          <% }) %>
        </div>
        <div class="absolute bottom-8 left-1/2 -translate-x-1/2 flex gap-2.5 z-20" id="carousel-dots"></div>
    </section>

    <!-- FILTROS Y ORDENAMIENTO -->
    <div id="restaurantes" class="mb-10 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
        <div>
            <h2 class="text-3xl font-black text-gray-900 tracking-tight">Selecci√≥n Exclusiva</h2>
            <p class="text-gray-500 font-medium text-sm mt-1">Mostrando <%= restaurantes.length %> de <%= totalItems %> lugares √∫nicos.</p>
        </div>
        
        <div class="flex flex-wrap gap-3">
            <div class="bg-white p-1 rounded-2xl shadow-sm border border-gray-100 flex gap-1">
                <a href="?filter=all<%= currentSort ? '&sort=' + currentSort : '' %><%= searchTerm ? '&search=' + searchTerm : '' %>#restaurantes" 
                   class="px-4 py-2 rounded-xl text-xs font-bold transition-all <%= currentFilter === 'all' ? 'bg-[var(--primary-color)] text-white' : 'text-gray-400 hover:text-gray-600' %>">
                  Todos
                </a>
                <a href="?filter=open<%= currentSort ? '&sort=' + currentSort : '' %><%= searchTerm ? '&search=' + searchTerm : '' %>#restaurantes" 
                   class="px-4 py-2 rounded-xl text-xs font-bold transition-all <%= currentFilter === 'open' ? 'bg-[var(--primary-color)] text-white' : 'text-gray-400 hover:text-gray-600' %>">
                  Abiertos
                </a>
            </div>

            <div class="bg-white p-1 rounded-2xl shadow-sm border border-gray-100 flex gap-1">
                <select onchange="window.location.href=this.value" class="px-4 py-2 rounded-xl text-xs font-bold text-gray-500 outline-none cursor-pointer">
                    <option value="?sort=popularity<%= currentFilter !== 'all' ? '&filter=' + currentFilter : '' %><%= searchTerm ? '&search=' + searchTerm : '' %>#restaurantes" <%= currentSort === 'popularity' ? 'selected' : '' %>>M√°s populares</option>
                    <option value="?sort=az<%= currentFilter !== 'all' ? '&filter=' + currentFilter : '' %><%= searchTerm ? '&search=' + searchTerm : '' %>#restaurantes" <%= currentSort === 'az' ? 'selected' : '' %>>Orden A-Z</option>
                    <option value="?sort=open<%= currentFilter !== 'all' ? '&filter=' + currentFilter : '' %><%= searchTerm ? '&search=' + searchTerm : '' %>#restaurantes" <%= currentSort === 'open' ? 'selected' : '' %>>Abiertos primero</option>
                </select>
            </div>
        </div>
    </div>

    <!-- GRID DE RESTAURANTES -->
    <div id="restaurant-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 md:gap-10">
      <% if (restaurantes && restaurantes.length > 0) { %>
        <% restaurantes.forEach(resto => { %>
          <article class="group bg-white rounded-[2.8rem] p-3 shadow-sm border border-gray-50 card-shadow hover:-translate-y-2 transition-all duration-300 relative">
            
            <!-- Bot√≥n de Like / Taxrate -->
            <div class="like-btn absolute top-6 right-6 z-20 w-12 h-12 bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl flex flex-col items-center justify-center text-gray-400 transition-all">
              <i class="fa-solid fa-star text-yellow-400"></i>
              <span class="like-count text-[9px] font-black mt-[-2px]">
                <%= resto.likes %>
              </span>
            </div>

            <!-- Imagen -->
            <div class="relative h-56 w-full overflow-hidden rounded-[2.4rem] mb-6">
              <img src="<%= resto.logo || '/assets/banner.png'%>" alt="Logo de <%= resto.name %>" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
              
              <!-- Badge Estado -->
              <div class="absolute bottom-4 left-4">
                  <span class="px-3 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-widest backdrop-blur-md <%= resto.isOpen ? 'bg-green-500/80 text-white' : 'bg-red-500/80 text-white' %>">
                    <%= resto.isOpen ? 'Abierto' : 'Cerrado' %>
                  </span>
              </div>
            </div>

            <!-- Contenido -->
            <div class="px-4 pb-4">
              <h3 class="text-2xl font-black text-gray-900 leading-none mb-4 group-hover:text-[var(--primary-color)] transition-colors">
                <%= resto.name %>
              </h3>
              
              <div class="space-y-3 mb-6">
                <div class="flex items-center gap-3 text-xs font-bold text-gray-400">
                  <div class="w-8 h-8 rounded-xl bg-gray-50 flex items-center justify-center text-[var(--primary-color)]">
                    <i class="fa-solid fa-location-dot"></i>
                  </div>
                  <span class="truncate max-w-[200px]"><%= resto.address %></span>
                </div>
                
                <div class="flex items-center gap-3 text-xs font-bold text-gray-400">
                    <div class="w-8 h-8 rounded-xl bg-gray-50 flex items-center justify-center text-[var(--primary-color)]">
                      <i class="fa-solid fa-clock"></i>
                    </div>
                    <% if (resto.hours.aperturaStr === 'Cerrado') { %>
                        <span class="text-red-400">Cerrado hoy</span>
                    <% } else { %>
                        <span><%= resto.hours.aperturaStr %> - <%= resto.hours.cierreStr %></span>
                    <% } %>
                </div>
              </div>

              <!-- Bot√≥n Acci√≥n -->
              <a href="<%= resto.id.startsWith('http') ? resto.id : '/' + resto.id %>" 
                 <%= resto.id.startsWith('http') ? 'target="_blank" rel="noopener noreferrer"' : '' %>
                 class="block w-full py-4 bg-gray-100 group-hover:bg-[var(--primary-color)] text-[var(--primary-color)] group-hover:text-white rounded-2xl font-black text-xs text-center uppercase tracking-widest transition-all">
                Ver Men√∫ Completo
              </a>
            </div>
          </article>
        <% }); %>
      <% } else { %>
        <div class="col-span-full py-24 text-center">
            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6 text-gray-300">
                <i class="fa-solid fa-utensils text-3xl"></i>
            </div>
            <p class="text-xl font-bold text-gray-400 italic">No hay resultados para tu b√∫squeda.</p>
            <a href="/lista" class="mt-4 inline-block text-[var(--primary-color)] font-bold hover:underline">Limpiar todos los filtros</a>
        </div>
      <% } %>
    </div>

    <!-- PAGINACI√ìN -->
    <% if (pagination.totalPages > 1) { %>
    <div class="mt-20 flex justify-center items-center gap-3 flex-wrap">
      
      <% if (pagination.hasPrev) { %>
        <a href="?page=<%= pagination.prevPage %><%= currentSort ? '&sort=' + currentSort : '' %><%= currentFilter ? '&filter=' + currentFilter : '' %><%= searchTerm ? '&search=' + searchTerm : '' %>#restaurantes" 
           class="w-14 h-14 flex items-center justify-center rounded-2xl bg-white border border-gray-100 text-gray-400 hover:text-[var(--primary-color)] hover:shadow-xl transition-all">
          <i class="fa-solid fa-chevron-left"></i>
        </a>
      <% } %>

      <% for (let i = 1; i <= pagination.totalPages; i++) { %>
        <a href="?page=<%= i %><%= currentSort ? '&sort=' + currentSort : '' %><%= currentFilter ? '&filter=' + currentFilter : '' %><%= searchTerm ? '&search=' + searchTerm : '' %>#restaurantes" 
           class="w-14 h-14 flex items-center justify-center rounded-2xl font-black transition-all <%= pagination.currentPage === i ? 'bg-[var(--primary-color)] text-white shadow-xl shadow-orange-200' : 'bg-white border border-gray-100 text-gray-400 hover:bg-gray-50' %>">
          <%= i %>
        </a>
      <% } %>

      <% if (pagination.hasNext) { %>
        <a href="?page=<%= pagination.nextPage %><%= currentSort ? '&sort=' + currentSort : '' %><%= currentFilter ? '&filter=' + currentFilter : '' %><%= searchTerm ? '&search=' + searchTerm : '' %>#restaurantes" 
           class="w-14 h-14 flex items-center justify-center rounded-2xl bg-white border border-gray-100 text-gray-400 hover:text-[var(--primary-color)] hover:shadow-xl transition-all">
          <i class="fa-solid fa-chevron-right"></i>
        </a>
      <% } %>

    </div>
    <% } %>

  </main>

  <!-- FOOTER -->
  <footer class="mt-20 py-16 bg-white border-t border-gray-100">
    <div class="max-w-7xl mx-auto px-6 text-center">
      <div class="mb-8">
          <span class="font-elegant text-4xl text-[var(--primary-color)] tracking-tighter"><%= info.name_page %></span>
      </div>
      <p class="text-gray-500 font-bold mb-4">¬øTienes un restaurante incre√≠ble?</p>
      <a href="https://wa.me/<%= info.whatsapp %>?text=Hola,%20quisiera%20a√±adir%20mi%20restaurante." 
        class="inline-block px-8 py-4 bg-emerald-500 text-white rounded-2xl font-black text-sm uppercase tracking-widest shadow-xl shadow-emerald-100 hover:bg-emerald-600 transition-all"
        target="_blank" rel="noopener noreferrer">
        Cont√°ctanos v√≠a WhatsApp
      </a>
      
      <div class="mt-16 pt-8 border-t border-gray-50 text-xs font-bold text-gray-300 uppercase tracking-[0.2em]">
          &copy; 2025 <%= info.name_page %>. Hecho para amantes de la comida.
      </div>
    </div>
  </footer>

  <script>
    async function handleLike(event, restauranteId, btn) {
      event.preventDefault();
      event.stopPropagation();
    
      if (btn.dataset.loading === 'true') return;
      btn.dataset.loading = 'true';
    
      const countSpan = btn.querySelector('.like-count');
    
      try {
        const res = await fetch(`/likes/${restauranteId}`, {
          method: 'POST'
        });
        const data = await res.json();
        countSpan.innerText = data.likes;
    
        if (data.liked) {
          btn.classList.add('like-active', 'text-[var(--primary-color)]');
          btn.classList.remove('text-gray-400');
          countSpan.classList.add('scale-125');
          setTimeout(() => countSpan.classList.remove('scale-125'), 200);
        } else {
          btn.classList.add('opacity-50');
        }
      } catch (e) {
        console.error('Like error:', e);
      } finally {
        btn.dataset.loading = 'false';
      }
    }
    document.addEventListener('DOMContentLoaded', async () => {
          /* -------------------------------
             1Ô∏è‚É£ Scroll autom√°tico (tu l√≥gica)
          -------------------------------- */
          const urlParams = new URLSearchParams(window.location.search);
          if (
            urlParams.get('page') ||
            urlParams.get('search') ||
            urlParams.get('filter')
          ) {
            const section = document.getElementById('restaurantes');
            if (section) {
              section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }
        
          /* -------------------------------
             2Ô∏è‚É£ Sincronizar likes + contador
          -------------------------------- */
          const buttons = document.querySelectorAll('.like-btn');
        
          for (const btn of buttons) {
            const restauranteId = btn.dataset.restaurante;
            const countSpan = btn.querySelector('.like-count');
        
            if (!restauranteId) continue;
        
            try {
              const res = await fetch(`/likes/${restauranteId}/status`);
              const data = await res.json();
        
              if (data.liked) {
                btn.classList.add('like-active', 'text-[var(--primary-color)]');
                btn.classList.remove('text-gray-400');
              }
        
              if (countSpan && typeof data.likes === 'number') {
                countSpan.innerText = data.likes;
              }
        
            } catch (err) {
              console.warn('No se pudo sincronizar likes:', restauranteId);
            }
          }
        
          /* -------------------------------
             3Ô∏è‚É£ Carrusel publicitario
          -------------------------------- */
          const inner = document.getElementById('carousel-inner');
          const dotsContainer = document.getElementById('carousel-dots');
          const items = document.querySelectorAll('.carousel-item');
        
          if (!inner || !dotsContainer || items.length <= 1) return;
        
          let currentIdx = 0;
          dotsContainer.innerHTML = '';
        
          items.forEach((_, i) => {
            const dot = document.createElement('div');
            dot.className = `h-2 transition-all duration-300 rounded-full ${
              i === 0
                ? 'w-10 bg-white'
                : 'w-2 bg-white/30 hover:bg-white/50 cursor-pointer'
            }`;
            dot.addEventListener('click', () => {
              currentIdx = i;
              updateCarousel();
            });
            dotsContainer.appendChild(dot);
          });
        
          function updateCarousel() {
            inner.style.transform = `translateX(-${currentIdx * 100}%)`;
            Array.from(dotsContainer.children).forEach((dot, i) => {
              dot.className = `h-2 transition-all duration-300 rounded-full ${
                i === currentIdx
                  ? 'w-10 bg-white'
                  : 'w-2 bg-white/30 hover:bg-white/50 cursor-pointer'
              }`;
            });
          }
        
          function nextSlide() {
            currentIdx = (currentIdx + 1) % items.length;
            updateCarousel();
          }
        
          let interval = setInterval(nextSlide, 6000);
        
          inner.parentElement.addEventListener('mouseenter', () => {
            clearInterval(interval);
          });
        
          inner.parentElement.addEventListener('mouseleave', () => {
            interval = setInterval(nextSlide, 6000);
          });
        
          /* -------------------------------
             4Ô∏è‚É£ Swipe t√°ctil
          -------------------------------- */
          let startX = 0;
          let endX = 0;
          const SWIPE_THRESHOLD = 50;
    
          inner.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
          }, { passive: true });
    
          inner.addEventListener('touchmove', (e) => {
            endX = e.touches[0].clientX;
          }, { passive: true });
    
          inner.addEventListener('touchend', () => {
            const diff = startX - endX;
    
            if (Math.abs(diff) < SWIPE_THRESHOLD) return;
    
            if (diff > 0) {
              currentIdx = (currentIdx + 1) % items.length;
            } else {
              currentIdx = (currentIdx - 1 + items.length) % items.length;
            }
    
            updateCarousel();
          });
    });
  </script>
  
  <%- include('partials/footer') %>
</body>
</html>