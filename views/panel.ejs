<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - <%= restaurante %></title>
    
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="shortcut icon" href="/assets/icon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" href="/assets/icon.png">
    <link rel="apple-touch-icon" href="/assets/icon.png">
  
    <link rel="stylesheet" href="/css/output.css">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" rel="stylesheet">
    <style>
        .table-responsive,
        .tabs-responsive {
            overflow-x: auto;
            max-width: 100%;
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }
        .table-responsive::-webkit-scrollbar,
        .tabs-responsive::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .table-responsive::-webkit-scrollbar-track,
        .tabs-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .table-responsive::-webkit-scrollbar-thumb,
        .tabs-responsive::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        .table-responsive::-webkit-scrollbar-thumb:hover,
        .tabs-responsive::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

    </style>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center flex-wrap gap-y-4 gap-x-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">üçî Panel de Control</h1>
                    <p class="text-gray-600">Restaurante: <span class="font-semibold"><%= restaurante %></span></p>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="bg-primary text-white px-3 py-1 rounded-full text-sm">
                        <i class="fas fa-store mr-1"></i> Activo
                    </span>
                    <button onclick="actualizarDatos()" class="bg-secondary text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i> Actualizar
                    </button>
                </div>
                <div class="w-full sm:w-auto">
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                      <button id="btnIniciarJornada" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 w-full sm:w-auto">
                        Iniciar Jornada
                      </button>
                      <button id="btnCerrarJornada" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 w-full sm:w-auto">
                        Cerrar Jornada
                      </button>
                    </div>
                    <span id="confirmarCierre" class="hidden text-sm text-gray-600 mt-2 text-center sm:text-left">
                      Clic nuevamente en <span id="contadorCierre">10</span>s para confirmar
                    </span>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Navegaci√≥n de pesta√±as -->
    <div class="bg-white shadow-sm">
        <div class="container mx-auto px-4">
            <div class="tabs-responsive overflow-x-auto whitespace-nowrap">
                <button onclick="cambiarPesta√±a('estadisticas')" id="tab-estadisticas" class="inline-block px-4 py-3 font-medium border-b-2 border-blue-500 text-blue-600">
                    <i class="fas fa-chart-bar mr-2"></i>Estad√≠sticas
                </button>
                <button onclick="cambiarPesta√±a('pendientes')" id="tab-pendientes" class="inline-block px-4 py-3 font-medium border-b-2 border-transparent text-gray-600 hover:text-blue-600">
                    <i class="fas fa-clock mr-2"></i>Pedidos Pendientes
                    <span id="badge-pendientes" class="ml-2 bg-red-500 text-white px-2 py-1 rounded-full text-xs hidden">0</span>
                </button>
                <button onclick="cambiarPesta√±a('historial')" id="tab-historial" class="inline-block px-4 py-3 font-medium border-b-2 border-transparent text-gray-600 hover:text-blue-600">
                    <i class="fas fa-history mr-2"></i>Historial
                </button>
                <button onclick="cambiarPesta√±a('seguridad')" id="tab-seguridad" class="inline-block px-4 py-3 font-medium border-b-2 border-transparent text-gray-600 hover:text-blue-600">
                    <i class="fas fa-shield-alt mr-2"></i>Seguridad
                </button>
                <!-- Puedes agregar m√°s pesta√±as aqu√≠ y se desplazar√°n en m√≥vil -->
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex items-center">
            <i class="fas fa-spinner fa-spin text-2xl text-blue-500 mr-3"></i>
            <p class="text-gray-700">Cargando datos...</p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Estad√≠sticas Principales -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Tarjeta Total Pedidos -->
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-gray-600 text-sm font-semibold">TOTAL PEDIDOS</h3>
                        <p class="text-3xl font-bold text-gray-800" id="total-pedidos">0</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i class="fas fa-shopping-bag text-blue-600 text-xl"></i>
                    </div>
                </div>
                <p class="text-green-600 text-sm mt-2">
                    <i class="fas fa-arrow-up"></i> <span id="pedidos-tendencia">0</span> este mes
                </p>
            </div>

            <!-- Tarjeta Total Gastado -->
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-gray-600 text-sm font-semibold">TOTAL GASTADO</h3>
                        <p class="text-3xl font-bold text-gray-800" id="total-gastado">$0</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
                    </div>
                </div>
                <p class="text-green-600 text-sm mt-2">
                    <i class="fas fa-arrow-up"></i> <span id="gastado-tendencia">$0</span> este mes
                </p>
            </div>

            <!-- Tarjeta Clientes √önicos -->
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-gray-600 text-sm font-semibold">CLIENTES √öNICOS</h3>
                        <p class="text-3xl font-bold text-gray-800" id="total-clientes">0</p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-full">
                        <i class="fas fa-users text-purple-600 text-xl"></i>
                    </div>
                </div>
                <p class="text-green-600 text-sm mt-2">
                    <i class="fas fa-arrow-up"></i> <span id="clientes-tendencia">0</span> nuevos este mes
                </p>
            </div>

            <!-- Tarjeta Pedidos Hoy -->
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-orange-500">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-gray-600 text-sm font-semibold">PEDIDOS HOY</h3>
                        <p class="text-3xl font-bold text-gray-800" id="pedidos-hoy">0</p>
                    </div>
                    <div class="bg-orange-100 p-3 rounded-full">
                        <i class="fas fa-calendar-day text-orange-600 text-xl"></i>
                    </div>
                </div>
                <p class="text-gray-600 text-sm mt-2">
                    <span id="gastado-hoy">$0</span> en ventas hoy
                </p>
            </div>
        </div>

        <!-- Filtros y Per√≠odos -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex flex-wrap gap-4 items-center">
                <h3 class="text-lg font-semibold text-gray-800">Filtrar por per√≠odo:</h3>
                <select id="filtro-periodo" class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="hoy">Hoy</option>
                    <option value="semana">Esta Semana</option>
                    <option value="mes" selected>Este Mes</option>
                    <option value="personalizado">Personalizado</option>
                </select>
                
                <div id="rango-fechas" class="hidden flex-wrap gap-2 items-center">
                    <input type="date" id="fecha-desde" class="border rounded-lg px-3 py-2 text-sm">
                    <span class="text-gray-600 text-sm">hasta</span>
                    <input type="date" id="fecha-hasta" class="border rounded-lg px-3 py-2 text-sm">
                    <button onclick="aplicarFiltroPersonalizado()" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 text-sm">
                        Aplicar
                    </button>
                </div>
                
                <button onclick="exportarDatos()" class="ml-auto bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 flex items-center">
                    <i class="fas fa-download mr-2"></i> Exportar CSV
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Estad√≠sticas del Per√≠odo -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Estad√≠sticas del Per√≠odo</h3>
                <div id="estadisticas-periodo" class="space-y-4">
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-600">Total Pedidos:</span>
                        <span class="font-semibold" id="periodo-pedidos">0</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-600">Total Gastado:</span>
                        <span class="font-semibold" id="periodo-gastado">$0</span>
                    </div>
                    <!-- En panel.ejs - Agregar estos elementos en estad√≠sticas del per√≠odo -->
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                      <span class="text-gray-600">Efectivo:</span>
                      <span class="font-semibold text-green-600" id="periodo-efectivo">$0</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                      <span class="text-gray-600">Transferencia:</span>
                      <span class="font-semibold text-blue-600" id="periodo-transferencia">$0</span>
                    </div>
                    <!-- <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-600">Promedio por Pedido:</span>
                        <span class="font-semibold" id="periodo-promedio">$0</span>
                    </div> -->
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="text-gray-600">Per√≠odo:</span>
                        <span class="font-semibold text-sm" id="periodo-fechas">Cargando...</span>
                    </div>
                </div>
            </div>

            <!-- Ranking de Clientes -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Top 10 Clientes</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-2 text-sm">#</th>
                                <th class="text-left py-2 text-sm">Tel√©fono</th>
                                <th class="text-right py-2 text-sm">Pedidos</th>
                                <th class="text-right py-2 text-sm">Total</th>
                            </tr>
                        </thead>
                        <tbody id="ranking-clientes">
                            <tr>
                                <td colspan="4" class="text-center py-4 text-gray-500">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>Cargando...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
         <!-- Pedidos Pendientes -->
        <div id="content-pendientes" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-clock mr-2 text-orange-500"></i>
                        Pedidos Pendientes
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="cargarPedidosPendientes()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                            <i class="fas fa-sync-alt mr-2"></i>Actualizar
                        </button>
                    </div>
                </div>

                <div id="sin-pedidos-pendientes" class="text-center py-8 text-gray-500 hidden">
                    <i class="fas fa-check-circle text-4xl text-green-500 mb-3"></i>
                    <p class="text-lg">No hay pedidos pendientes</p>
                    <p class="text-sm">Todos los pedidos est√°n gestionados</p>
                </div>

                <div id="lista-pedidos-pendientes" class="space-y-4">
                    <!-- Los pedidos pendientes se cargar√°n aqu√≠ -->
                </div>
            </div>
        </div>

        <!-- Historial de Pedidos -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                <h3 class="text-lg font-semibold text-gray-800">Historial de Pedidos Recientes</h3>
                <div class="flex gap-2 flex-wrap w-full sm:w-auto">
                    <input type="text" id="buscar-pedido" placeholder="Buscar tel√©fono..." 
                           class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm w-40">
                    <select id="filtro-tiempo" class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        <option value="all">Todos</option>
                        <option value="7">√öltimos 7 d√≠as</option>
                        <option value="30">√öltimos 30 d√≠as</option>
                    </select>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="w-full min-w-[600px]">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-2 text-sm">Fecha/Hora</th>
                            <th class="text-left py-2 text-sm">Tel√©fono/Cliente</th>
                            <th class="text-right py-2 text-sm">Valor</th>
                            <th class="text-center py-2 text-sm">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="historial-pedidos">
                        <tr>
                            <td colspan="4" class="text-center py-4 text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Cargando historial...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="flex justify-between items-center mt-4 flex-wrap gap-4">
                <span class="text-gray-600 text-sm" id="info-paginacion">Mostrando 0 de 0 pedidos</span>
                <div class="flex gap-2">
                    <button onclick="cambiarPagina('anterior')" class="bg-gray-200 px-3 py-1 rounded-lg hover:bg-gray-300 text-sm disabled:opacity-50" id="btn-anterior">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="px-3 py-1 bg-blue-500 text-white rounded-lg text-sm" id="pagina-actual">1</span>
                    <button onclick="cambiarPagina('siguiente')" class="bg-gray-200 px-3 py-1 rounded-lg hover:bg-gray-300 text-sm disabled:opacity-50" id="btn-siguiente">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Pesta√±a de Seguridad -->
        <div id="content-seguridad" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg p-6 mt-6 mb-4">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">
                    <i class="fas fa-shield-alt mr-2 text-gray-500"></i>
                    Cambiar Contrase√±a (Token)
                </h2>
                <form id="form-cambiar-token" class="max-w-md space-y-4">
                    <div>
                        <label for="token-actual" class="block text-sm font-medium text-gray-700">Contrase√±a Actual</label>
                        <input type="password" id="token-actual" name="token-actual" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="token-nuevo" class="block text-sm font-medium text-gray-700">Nueva Contrase√±a</label>
                        <input type="password" id="token-nuevo" name="token-nuevo" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="token-confirmar" class="block text-sm font-medium text-gray-700">Confirmar Nueva Contrase√±a</label>
                        <input type="password" id="token-confirmar" name="token-confirmar" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-500 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Cambiar Contrase√±a
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Modal para detalles del pedido -->
    <div id="modal-detalles" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Detalles Completos del Pedido</h3>
                <button onclick="cerrarModal()" class="text-gray-500 hover:text-gray-700 text-lg">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modal-contenido" class="space-y-4">
                <!-- Contenido din√°mico -->
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="cerrarModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal para rechazar pedido -->
    <div id="modal-rechazar" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Rechazar Pedido</h3>
                <button onclick="cerrarModalRechazar()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Motivo del rechazo:</label>
                <textarea id="motivo-rechazo" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" rows="4" placeholder="¬øPor qu√© se rechaza este pedido?"></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="cerrarModalRechazar()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    Cancelar
                </button>
                <button onclick="confirmarRechazo()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                    <i class="fas fa-times mr-2"></i>Rechazar Pedido
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white shadow-lg mt-8">
        <div class="container mx-auto px-4 py-4 text-center text-gray-600">
            <p>¬© 2024 Sistema de Gesti√≥n de Pedidos. Todos los derechos reservados.</p>
            <p class="text-sm mt-1">√öltima actualizaci√≥n: <span id="ultima-actualizacion"><%= new Date().toLocaleString() %></span></p>
        </div>
    </footer>

    <script>
        const extension = '<%= restaurante %>';
        let paginaActual = 1;
        const limitePorPagina = 10;
        let filtroActual = 'mes';
        let totalPedidos = 0;
        let todosLosPedidos = [];
        let socket = null;

        function inicializarSocket() {
            if (socket) return;

            socket = io();

            socket.on('connect', () => {
                console.log('Conectado...');
                socket.emit('joinRoom', extension);
            });

            socket.on('pedido:nuevo', (pedido) => {
                mostrarMensaje(`Nuevo pedido de ${pedido.nombreCliente}`, 'info');
                agregarPedidoPendiente(pedido);
            });
            
            socket.on('pedido-aceptado', (pedido) => {
                mostrarMensaje(`Pedido #${pedido._id.substring(18, 24)} aceptado`, 'success');
                eliminarPedidoPendiente(pedido._id);
            });

            socket.on('pedido-rechazado', (pedido) => {
                mostrarMensaje(`Pedido #${pedido._id.substring(18, 24)} rechazado`, 'error');
                eliminarPedidoPendiente(pedido._id);
            });
        }

        function agregarPedidoPendiente(pedido) {
            const contenedor = document.getElementById('lista-pedidos-pendientes');
            const sinPedidos = document.getElementById('sin-pedidos-pendientes');

            sinPedidos.classList.add('hidden');

            const pedidoHTML = crearPedidoHTML(pedido);
            contenedor.insertAdjacentHTML('afterbegin', pedidoHTML);

            const totalPendientes = contenedor.children.length;
            actualizarBadgePendientes(totalPendientes);
        }

        function eliminarPedidoPendiente(pedidoId) {
            const pedidoEl = document.getElementById(`pedido-${pedidoId}`);
            if (pedidoEl) {
                pedidoEl.remove();
            }

            const contenedor = document.getElementById('lista-pedidos-pendientes');
            const totalPendientes = contenedor.children.length;

            if (totalPendientes === 0) {
                document.getElementById('sin-pedidos-pendientes').classList.remove('hidden');
            }
            actualizarBadgePendientes(totalPendientes);
        }

        function cambiarPesta√±a(pesta√±a) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('button[id^="tab-"]').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-600');
            });
            document.getElementById(`content-${pesta√±a}`).classList.add('active');
            document.getElementById(`tab-${pesta√±a}`).classList.add('border-blue-500', 'text-blue-600');
            document.getElementById(`tab-${pesta√±a}`).classList.remove('border-transparent', 'text-gray-600');
            
            if (pesta√±a === 'pendientes') {
                cargarPedidosPendientes();
            } else if (pesta√±a === 'historial') {
                cargarHistorialPedidos();
            }
        }
        async function cargarPedidosPendientes() {
            mostrarLoading(true);
            try {
                const response = await fetch(`/pedidos/${extension}/pendientes`);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Error ${response.status}: ${response.statusText}`);
                }
                
                const pedidos = await response.json();
                
                if (pedidos.error) {
                    throw new Error(pedidos.error);
                }
                
                mostrarPedidosPendientes(pedidos);
                actualizarBadgePendientes(pedidos.length);
                
            } catch (error) {
                if (error.message.includes('403')) {
                    mostrarError('Acceso no autorizado. Verifica el token.');
                } else if (error.message.includes('404')) {
                    mostrarError('No se encontraron pedidos pendientes.');
                } else if (error.message.includes('500')) {
                    mostrarError('Error interno del servidor.');
                } else {
                    mostrarError(error.message || 'Error al cargar pedidos pendientes');
                }
            } finally {
                mostrarLoading(false);
            }
        }
        
        function crearPedidoHTML(pedido) {
            const fecha = new Date(pedido.fechaPedido).toLocaleString('es-CO');
            const total = pedido.valorTotal || pedido.valorPedido;

            return `
                <div id="pedido-${pedido._id}" class="bg-orange-50 border border-orange-200 rounded-lg p-4 animate-fade-in">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-semibold text-orange-800">Pedido #${pedido._id.toString().substring(18, 24)}</h3>
                            <p class="text-sm text-gray-600">${fecha}</p>
                        </div>
                        <span class="bg-orange-500 text-white px-2 py-1 rounded-full text-xs">Pendiente</span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <p class="text-sm"><span class="font-medium">Cliente:</span> ${pedido.nombreCliente || 'N/A'}</p>
                            <p class="text-sm"><span class="font-medium">Tel√©fono:</span> ${pedido.phone}</p>
                            <p class="text-sm"><span class="font-medium">Direcci√≥n:</span> ${pedido.direccion || 'N/A'}</p>
                        </div>
                        <div>
                            <p class="text-sm"><span class="font-medium">Total:</span> <span class="font-bold text-green-600">$${total.toLocaleString('es-CO')}</span></p>
                            <p class="text-sm"><span class="font-medium">Pago:</span> ${pedido.metodoPago}</p>
                            ${pedido.observacionGeneral ? `<p class="text-sm"><span class="font-medium">Obs:</span> "${pedido.observacionGeneral}"</p>` : ''}
                        </div>
                    </div>

                    <div class="flex justify-end space-x-2">
                        <button onclick='verDetallesPedidoCompleto(${JSON.stringify(pedido).replace(/"/g, "&quot;")})'
                                class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">
                            <i class="fas fa-eye mr-1"></i> Ver Detalles
                        </button>
                    </div>
                </div>
            `;
        }

        function mostrarPedidosPendientes(pedidos) {
            const contenedor = document.getElementById('lista-pedidos-pendientes');
            const sinPedidos = document.getElementById('sin-pedidos-pendientes');
            
            if (pedidos.length === 0) {
                contenedor.innerHTML = '';
                sinPedidos.classList.remove('hidden');
            } else {
                sinPedidos.classList.add('hidden');
                contenedor.innerHTML = pedidos.map(crearPedidoHTML).join('');
            }
        }
        
        function actualizarBadgePendientes(cantidad) {
            const badge = document.getElementById('badge-pendientes');
            if (cantidad !== undefined) {
                if (cantidad > 0) {
                    badge.textContent = cantidad;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

async function aceptarPedido(pedidoId) {
    if (!confirm('¬øEst√°s seguro de aceptar este pedido?')) return;
    const pedido = todosLosPedidos.find(p => p._id === pedidoId);
    let valorDomicilio = pedido?.valorDomicilio ?? null;
    const inputDomicilio = document.getElementById(`input-domicilio-${pedidoId}`);
    
    if (!valorDomicilio) {
        if (!inputDomicilio) {
            mostrarError('‚ùå No se encontr√≥ el input de domicilio');
            return;
        }

        const valor = inputDomicilio.value.trim();
        if (valor === '') {
            mostrarError('‚ùå El valor del domicilio es obligatorio');
            inputDomicilio.focus();
            inputDomicilio.classList.add('border-red-500', 'ring-2', 'ring-red-200');
            return;
        }

        valorDomicilio = parseFloat(valor);
        if (isNaN(valorDomicilio) || valorDomicilio < 0) {
            mostrarError('‚ùå Ingrese un valor v√°lido para el domicilio');
            inputDomicilio.focus();
            inputDomicilio.classList.add('border-red-500', 'ring-2', 'ring-red-200');
            return;
        }
    }

    mostrarLoading(true);

    try {
        const response = await fetch(`/pedidos/${pedidoId}/aceptar`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ valorDomicilio })
        });

        if (response.ok) {
            mostrarMensaje('‚úÖ Pedido aceptado correctamente', 'success');
            cerrarModal();
            cargarDatosIniciales();
        } else {
            const data = await response.json();
            if (data.error && data.error.includes('No hay jornada iniciada')) {
                mostrarError('‚ö†Ô∏è No hay jornada iniciada. Inicie jornada para aceptar pedidos.');
            } else {
                mostrarError('Error al aceptar el pedido');
            }
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarError('‚ö†Ô∏è Error al aceptar el pedido');
    } finally {
        mostrarLoading(false);
    }
}
        function rechazarPedido(pedidoId) {
            pedidoSeleccionado = pedidoId;
            document.getElementById('motivo-rechazo').value = '';
            document.getElementById('modal-rechazar').classList.remove('hidden');
        }
        async function confirmarRechazo() {
            const motivo = document.getElementById('motivo-rechazo').value.trim();
            if (!motivo) {
                mostrarError('Por favor ingresa un motivo para rechazar el pedido');
                return;
            }
            
            mostrarLoading(true);
            try {
                const response = await fetch(`/pedidos/${pedidoSeleccionado}/rechazar?motivo=${encodeURIComponent(motivo)}`, {
                    method: 'PUT'
                });
                
                if (response.ok) {
                    mostrarMensaje('Pedido rechazado correctamente', 'success');
                    cerrarModalRechazar();
                    cargarDatosIniciales();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al rechazar pedido');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarError(error.message || 'Error al rechazar el pedido');
            } finally {
                mostrarLoading(false);
            }
        }
        function cerrarModalRechazar() {
            document.getElementById('modal-rechazar').classList.add('hidden');
            pedidoSeleccionado = null;
        }
        document.addEventListener('DOMContentLoaded', function() {
            const hoy = new Date();
            const hace7Dias = new Date();
            hace7Dias.setDate(hace7Dias.getDate() - 7);
            
            document.getElementById('fecha-desde').value = hace7Dias.toISOString().split('T')[0];
            document.getElementById('fecha-hasta').value = hoy.toISOString().split('T')[0];
            
            cargarDatosIniciales();
            configurarEventListeners();
            inicializarSocket();
        });
        
        document.getElementById('btnIniciarJornada').addEventListener('click', async () => {
          const res = await fetch('/jornada/iniciar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ extension })
          });
          const data = await res.json();
          if (data.ok) {
            mostrarMensaje('‚úÖ Jornada iniciada', 'success');
          } else {
            if (data.error === 'Jornada sin finalizar') {
              mostrarMensaje('Hay una jornada disponible sin cerrar.', 'error')
            } else {
              alert('‚ö†Ô∏è ' + data.message);
            }
          }
        });

      let confirmando = false;
      let contador = 10;
      let interval;
      document.getElementById('btnCerrarJornada').addEventListener('click', async () => {
        if (!confirmando) {
          confirmando = true;
          contador = 10;
          document.getElementById('confirmarCierre').classList.remove('hidden');
          document.getElementById('contadorCierre').textContent = contador;
      
          interval = setInterval(() => {
            contador--;
            if (contador <= 0) {
              clearInterval(interval);
              confirmando = false;
              document.getElementById('confirmarCierre').classList.add('hidden');
            } else {
              document.getElementById('contadorCierre').textContent = contador;
            }
          }, 1000);
        } else {
          clearInterval(interval);
          confirmando = false;
          document.getElementById('confirmarCierre').classList.add('hidden');
      
          const res = await fetch('/jornada/cerrar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ extension })
          });
          const data = await res.json();
          if (data.ok) {
            mostrarMensaje('‚úÖ Jornada cerrada', 'success');
          } else {
            alert('‚ö†Ô∏è ' + (data.message || 'Error al cerrar jornada'));
          }
        }
      });

      
        function configurarEventListeners() {
            document.getElementById('filtro-periodo').addEventListener('change', function(e) {
                if (e.target.value === 'personalizado') {
                    document.getElementById('rango-fechas').classList.remove('hidden');
                } else {
                    document.getElementById('rango-fechas').classList.add('hidden');
                    filtroActual = e.target.value;
                    cargarEstadisticasPeriodo();
                }
            });

            document.getElementById('buscar-pedido').addEventListener('input', function(e) {
                filtrarPedidos(e.target.value);
            });

            document.getElementById('filtro-tiempo').addEventListener('change', function(e) {
                aplicarFiltroTiempo(e.target.value);
            });
        }

        function mostrarLoading(mostrar) {
            document.getElementById('loading-overlay').classList.toggle('hidden', !mostrar);
        }

        async function cargarDatosIniciales() {
            mostrarLoading(true);
            try {
                await Promise.all([
                    cargarEstadisticasGenerales(),
                    cargarEstadisticasPeriodo(),
                    cargarRankingClientes(),
                    cargarPedidosPendientes(),
                    cargarHistorialPedidos(),
                    cargarEstadisticasHoy()
                ]);
                
                document.getElementById('ultima-actualizacion').textContent = new Date().toLocaleString();
                mostrarMensaje('Datos cargados correctamente', 'success');
            } catch (error) {
                console.error('Error:', error);
                mostrarError('Error al cargar datos iniciales');
            } finally {
                mostrarLoading(false);
            }
        }

        async function cargarEstadisticasGenerales() {
            try {
                const response = await fetch(`/panel/${extension}/estadisticas`);
                if (!response.ok) throw new Error('Error en la respuesta del servidor');
                
                const data = await response.json();
                
                document.getElementById('total-pedidos').textContent = data.totalPedidos.toLocaleString();
                document.getElementById('total-gastado').textContent = `$${data.totalGastado.toLocaleString()}`;
                document.getElementById('total-clientes').textContent = data.totalClientes.toLocaleString();
                
                if (data.efectivo !== undefined) {
                    document.getElementById('total-efectivo').textContent = `$${data.totalEfectivo.toLocaleString()}`;
                    document.getElementById('total-transferencia').textContent = `$${data.totalTransferencia.toLocaleString()}`;
                }
        
            } catch (error) {
                console.error('Error cargando estad√≠sticas generales:', error);
                mostrarError('Error al cargar estad√≠sticas');
            }
        }

        async function cargarEstadisticasHoy() {
            try {
                const response = await fetch(`/panel/${extension}/estadisticas-periodo?periodo=hoy`);
                
                if (!response.ok) throw new Error('Error en la respuesta');
                
                const data = await response.json();
                
                document.getElementById('pedidos-hoy').textContent = data.totalPedidos || 0;
                document.getElementById('gastado-hoy').textContent = `$${(data.totalGastado || 0).toLocaleString()}`;
                
            } catch (error) {
                console.error('Error cargando estad√≠sticas de hoy:', error);
                document.getElementById('pedidos-hoy').textContent = '0';
                document.getElementById('gastado-hoy').textContent = '$0';
            }
        }

        async function cargarEstadisticasPeriodo() {
            try {
                const response = await fetch(`/panel/${extension}/estadisticas-periodo?periodo=${filtroActual}`);
                if (!response.ok) throw new Error('Error en la respuesta');
                
                const data = await response.json();
                console.log(data)
                document.getElementById('periodo-pedidos').textContent = data.totalPedidos.toLocaleString();
                document.getElementById('periodo-gastado').textContent = `$${data.totalGastado.toLocaleString()}`;
                /*
                const promedio = data.totalPedidos > 0 ? (data.totalGastado / data.totalPedidos).toFixed(2) : 0;
                document.getElementById('periodo-promedio').textContent = `$${promedio}`;
                */
                document.getElementById('periodo-efectivo').textContent = `$${(data.totalEfectivo || 0).toLocaleString()}`;
                document.getElementById('periodo-transferencia').textContent = `$${(data.totalTransferencia || 0).toLocaleString()}`;
                
                let fechaTexto = '';
                if (filtroActual === 'hoy') {
                    fechaTexto = 'Hoy';
                } else if (filtroActual === 'semana') {
                    fechaTexto = `Esta semana (${data.semana})`;
                } else if (filtroActual === 'mes') {
                    fechaTexto = `Mes ${data.mes}`;
                }
                document.getElementById('periodo-fechas').textContent = fechaTexto;
                
            } catch (error) {
                console.error('Error cargando estad√≠sticas del per√≠odo:', error);
                mostrarError('Error al cargar estad√≠sticas del per√≠odo');
            }
        }
        
        async function cargarRankingClientes() {
            try {
                const response = await fetch(`/panel/${extension}/ranking-clientes`);
                if (!response.ok) throw new Error('Error en la respuesta');
                
                const data = await response.json();
                const tbody = document.getElementById('ranking-clientes');
                tbody.innerHTML = '';
                
                if (data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center py-4 text-gray-500">
                                No hay clientes registrados
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                data.slice(0, 10).forEach((cliente, index) => {
                    const row = `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 text-sm">${index + 1}</td>
                            <td class="py-3 text-sm">${cliente.telefono || cliente.phone}</td>
                            <td class="py-3 text-sm text-right">${cliente.totalPedidos}</td>
                            <td class="py-3 text-sm text-right font-semibold">$${cliente.totalGastado.toLocaleString()}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                
            } catch (error) {
                console.error('Error cargando ranking de clientes:', error);
                mostrarError('Error al cargar ranking');
            }
        }

        async function cargarHistorialPedidos() {
            try {
                const response = await fetch(`/panel/${extension}/historial-pedidos?page=${paginaActual}&limit=${limitePorPagina}`);
                if (!response.ok) throw new Error('Error en la respuesta');
                
                const data = await response.json();
                totalPedidos = data.paginacion.total;
                todosLosPedidos = data.pedidos;
                
                mostrarPedidosEnTabla(data.pedidos);
                actualizarPaginacion(data.paginacion);
                
            } catch (error) {
                console.error('Error cargando historial de pedidos:', error);
                mostrarError('Error al cargar historial');
            }
        }
        
        function mostrarPedidosEnTabla(pedidos) {
            const tbody = document.getElementById('historial-pedidos');
            tbody.innerHTML = '';
            
            pedidos.forEach((pedido, index) => {
                const fecha = new Date(pedido.fechaPedido).toLocaleString('es-CO', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const valorPedido = pedido.valorPedido || 0;
                const valorDomicilio = pedido.valorDomicilio || 0;
                const valorTotal = valorPedido + valorDomicilio;
                
                const rowClass = pedido.estado === 'rechazado' 
                    ? 'bg-red-50 hover:bg-red-100 border-l-4 border-red-500' 
                    : 'hover:bg-gray-50';
                
                const estadoBadge = pedido.estado === 'rechazado' 
                    ? '<span class="bg-red-500 text-white px-2 py-1 rounded-full text-xs">Rechazado</span>'
                    : (pedido.estado === 'aceptado' 
                        ? '<span class="bg-green-500 text-white px-2 py-1 rounded-full text-xs">Aceptado</span>'
                        : '<span class="bg-blue-500 text-white px-2 py-1 rounded-full text-xs">Pendiente</span>');
                
                const row = `
                    <tr class="border-b ${rowClass}">
                        <td class="py-3 text-sm">${fecha}</td>
                        <td class="py-3 text-sm">
                            <div class="font-medium">${pedido.phone}</div>
                            ${pedido.nombreCliente ? `<div class="text-xs text-gray-600">${pedido.nombreCliente}</div>` : ''}
                            <div class="mt-1">${estadoBadge}</div>
                        </td>
                        <td class="py-3 text-sm text-right font-semibold">$${valorTotal.toLocaleString()}</td>
                        <td class="py-3 text-sm text-center">
                            <span class="inline-block px-2 py-1 rounded text-xs ${
                                pedido.metodoPago === 'efectivo' 
                                    ? 'bg-green-100 text-green-800' 
                                    : 'bg-blue-100 text-blue-800'
                            }">
                                ${pedido.metodoPago === 'efectivo' ? 'Efectivo' : 'Transferencia'}
                            </span>
                        </td>
                        <td class="py-3 text-sm text-center">
                            <button onclick="verDetallesPorIndice(${index})" 
                                    class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">
                                <i class="fas fa-eye mr-1"></i> Ver
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        function actualizarPaginacion(paginacion) {
            document.getElementById('info-paginacion').textContent = 
                `Mostrando ${paginacion.total > 0 ? ((paginaActual - 1) * limitePorPagina) + 1 : 0} - ${Math.min(paginaActual * limitePorPagina, paginacion.total)} de ${paginacion.total} pedidos`;
            document.getElementById('pagina-actual').textContent = paginaActual;
            document.getElementById('btn-anterior').disabled = paginaActual === 1;
            document.getElementById('btn-siguiente').disabled = paginaActual >= paginacion.paginas;
        }

        function cambiarPagina(direccion) {
            if (direccion === 'siguiente') {
                paginaActual++;
            } else if (direccion === 'anterior' && paginaActual > 1) {
                paginaActual--;
            }
            cargarHistorialPedidos();
        }
        
        function aplicarFiltroPersonalizado() {
            const desde = document.getElementById('fecha-desde').value;
            const hasta = document.getElementById('fecha-hasta').value;
            
            if (!desde || !hasta) {
                mostrarError('Por favor selecciona ambas fechas');
                return;
            }
            
            mostrarMensaje('Filtro aplicado para fechas personalizadas', 'info');
            // Aqu√≠ implementar√≠as la l√≥gica espec√≠fica para filtrar por fechas
        }
        
        function filtrarPedidos(termino) {
            if (!termino) {
                mostrarPedidosEnTabla(todosLosPedidos);
                return;
            }
            
            const pedidosFiltrados = todosLosPedidos.filter(pedido => 
                pedido.phone.includes(termino) ||
                (pedido.nombreCliente && pedido.nombreCliente.toLowerCase().includes(termino.toLowerCase()))
            );
            mostrarPedidosEnTabla(pedidosFiltrados);
        }
        
        function aplicarFiltroTiempo(dias) {
            if (dias === 'all') {
                mostrarPedidosEnTabla(todosLosPedidos);
                return;
            }
            
            const limiteFecha = new Date();
            limiteFecha.setDate(limiteFecha.getDate() - parseInt(dias));
            
            const pedidosFiltrados = todosLosPedidos.filter(pedido => 
                new Date(pedido.fechaPedido) >= limiteFecha
            );
            mostrarPedidosEnTabla(pedidosFiltrados);
        }
        
        /*function verDetallesPedido(phone, valor, fecha) {
            const pedidoCompleto = todosLosPedidos.find(p => 
                p.phone === phone && 
                p.valorPedido === valor && 
                new Date(p.fechaPedido).getTime() === new Date(fecha).getTime()
            );
            
            if (pedidoCompleto) {
                mostrarDetallesPedidoModal(pedidoCompleto);
            } else {
                mostrarError('No se encontraron los detalles completos del pedido');
            }
        }*/
        
        function verDetallesPorIndice(index) {
          const pedido = todosLosPedidos[index];
          if (!pedido) return;
          verDetallesPedido(pedido);
        }

        function verDetallesPedidoCompleto(pedido) {
            const pedidoObj = typeof pedido === 'string' ? JSON.parse(pedido) : pedido;
            //mostrarDetallesPedidoModal(pedidoObj);
            verDetallesPedido(pedidoObj);
        }
        
        function mostrarDetallesPedidoModal(pedido) {
            const modal = document.getElementById('modal-detalles');
            const contenido = document.getElementById('modal-contenido');
            
            const fechaFormateada = new Date(pedido.fechaPedido).toLocaleString('es-CO', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let itemsHTML = '';
            if (pedido.items && pedido.items.length > 0) {
                itemsHTML = `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-3">üì¶ Productos del Pedido</h4>
                        <div class="space-y-3">
                `;
                
                pedido.items.forEach((item, index) => {
                    itemsHTML += `
                        <div class="border-b pb-3 last:border-b-0">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="font-medium">${item.cantidad}x ${item.categoria} ${item.nombre}</p>
                                    ${item.variante ? `<p class="text-sm text-gray-600">Variante: ${item.variante}</p>` : ''}
                                    ${item.observacion ? `<p class="text-sm text-gray-600 mt-1">Observaci√≥n: <span class="italic">"${item.observacion}"</span></p>` : ''}
                                    <p class="text-sm text-gray-500">${item.categoria}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm">$${item.precio.toLocaleString()} c/u</p>
                                    <p class="font-semibold text-green-600">$${item.subtotal.toLocaleString()}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                itemsHTML += `
                        </div>
                    </div>
                `;
            } else {
                itemsHTML = `
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <p class="text-yellow-700">No hay detalles de productos disponibles para este pedido.</p>
                    </div>
                `;
            }
        
            contenido.innerHTML = `
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h4 class="text-lg font-semibold">Detalles del Pedido</h4>
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${
                            pedido.estado === 'aceptado' ? 'bg-green-100 text-green-800' :
                            pedido.estado === 'rechazado' ? 'bg-red-100 text-red-800' :
                            'bg-yellow-100 text-yellow-800'
                        }">
                            ${pedido.estado?.toUpperCase() || 'PENDIENTE'}
                        </span>
                    </div>
                    
                    ${pedido.estado === 'rechazado' && pedido.motivoRechazo ? `
                    <div class="bg-red-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-red-800 mb-2">‚ùå Motivo de Rechazo</h4>
                        <p class="text-red-700">"${pedido.motivoRechazo}"</p>
                    </div>
                    ` : ''}
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-blue-800 mb-3">üë§ Informaci√≥n del Cliente</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="text-gray-600">Nombre:</span>
                                <p class="font-medium">${pedido.nombreCliente || 'No especificado'}</p>
                            </div>
                            <div>
                                <span class="text-gray-600">Tel√©fono:</span>
                                <p class="font-medium">${pedido.phone}</p>
                            </div>
                            <div class="md:col-span-2">
                                <span class="text-gray-600">Direcci√≥n:</span>
                                <p class="font-medium">${pedido.direccion || 'No especificada'}</p>
                            </div>
                        </div>
                    </div>
        
                    ${itemsHTML}
        
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-green-800 mb-3">üí∞ Informaci√≥n de Pago</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="text-gray-600">M√©todo:</span>
                                <p class="font-medium">${pedido.metodoPago === 'efectivo' ? 'Efectivo üíµ' : 'Transferencia üí≥'}</p>
                            </div>
                            ${pedido.metodoPago === 'efectivo' && pedido.pagaCon ? `
                            <div>
                                <span class="text-gray-600">Paga con:</span>
                                <p class="font-medium">$${pedido.pagaCon.toLocaleString()}</p>
                            </div>
                            ` : ''}
                            <div class="col-span-2">
                                <span class="text-gray-600">Total del pedido:</span>
                                <p class="text-xl font-bold text-green-600">$${pedido.valorPedido.toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
        
                    ${pedido.observacionGeneral ? `
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-yellow-800 mb-2">üìù Observaci√≥n General</h4>
                        <p class="text-gray-700 italic">"${pedido.observacionGeneral}"</p>
                    </div>
                    ` : ''}
        
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">üìã Informaci√≥n del Pedido</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="text-gray-600">Fecha y hora:</span>
                                <p class="font-medium">${fechaFormateada}</p>
                            </div>
                            <div>
                                <span class="text-gray-600">Restaurante:</span>
                                <p class="font-medium">${extension}</p>
                            </div>
                            ${pedido._id ? `
                            <div>
                                <span class="text-gray-600">ID del pedido:</span>
                                <p class="font-medium">${pedido._id.toString().substring(18, 24)}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }
        
        function cerrarModal() {
          document.getElementById('modal-detalles').classList.add('hidden');
        }
        
        function exportarDatos() {
            if (todosLosPedidos.length === 0) {
                mostrarError('No hay datos para exportar');
                return;
            }
            
            mostrarLoading(true);
            
            try {
                let csvContent = "Fecha,Tel√©fono,Valor\n";
                todosLosPedidos.forEach(pedido => {
                    const fecha = new Date(pedido.fechaPedido).toLocaleString('es-CO');
                    csvContent += `"${fecha}","${pedido.phone}","${pedido.valorPedido}"\n`;
                });
                const blob = new Blob(["\uFEFF" + csvContent], {
                    type: "text/csv;charset=utf-8;"
                });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `pedidos_${extension}_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
                mostrarMensaje('Datos exportados correctamente', 'success');
            } catch (error) {
                console.error('Error exportando datos:', error);
                mostrarError('Error al exportar datos');
            } finally {
                mostrarLoading(false);
            }
        }
        function verDetallesPedido(pedido) {
            const modal = document.getElementById('modal-detalles');
            const contenido = document.getElementById('modal-contenido');
        
            const fechaFormateada = new Date(pedido.fechaPedido).toLocaleString('es-CO', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        
            let itemsHTML = '';
            if (pedido.items && pedido.items.length > 0) {
                itemsHTML = `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-3">Detalles del Pedido</h4>
                        <div class="space-y-3">
                `;
        
                pedido.items.forEach((item) => {
                    itemsHTML += `
                        <div class="border-b pb-2 last:border-b-0">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="font-medium">${item.cantidad}x ${item.nombre}</p>
                                    ${item.variante ? `<p class="text-sm text-gray-600">Variante: ${item.variante}</p>` : ''}
                                    ${item.observacion ? `<p class="text-sm text-gray-600">Observaci√≥n: ${item.observacion}</p>` : ''}
                                </div>
                                <div class="text-right">
                                    <p class="text-sm">$${item.precio.toLocaleString()} c/u</p>
                                    <p class="font-semibold">$${item.subtotal.toLocaleString()}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
        
                itemsHTML += `
                        </div>
                    </div>
                `;
            }
            let valorPedido = pedido.valorPedido || 0;
            let valorDomicilio = pedido.valorDomicilio ?? 0;
            let mostrarInputDomicilio = pedido.valorDomicilio === null || pedido.valorDomicilio === undefined || pedido.valorDomicilio === 0;
            let valorTotal = valorPedido + valorDomicilio;
        
            contenido.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-blue-800 mb-3">Informaci√≥n del Cliente</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="text-gray-600">Nombre:</span>
                                <p class="font-medium">${pedido.nombreCliente || 'No especificado'}</p>
                            </div>
                            <div>
                                <span class="text-gray-600">Tel√©fono:</span>
                                <p class="font-medium">${pedido.phone}</p>
                            </div>
                            <div class="col-span-2">
                                <span class="text-gray-600">Direcci√≥n:</span>
                                <p class="font-medium">${pedido.direccion || 'No especificada'}</p>
                            </div>
                        </div>
                    </div>
        
                    ${itemsHTML}
        
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-green-800 mb-3">Informaci√≥n de Pago</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="text-gray-600">M√©todo:</span>
                                <p class="font-medium">${pedido.metodoPago === 'efectivo' ? 'Efectivo üíµ' : 'Transferencia üí≥'}</p>
                            </div>
                            ${pedido.metodoPago === 'efectivo' && pedido.pagaCon ? `
                            <div>
                                <span class="text-gray-600">Paga con:</span>
                                <p class="font-medium">$${pedido.pagaCon.toLocaleString()}</p>
                            </div>` : ''}
        
                            <div class="col-span-2">
                                <span class="text-gray-600">Subtotal Pedido:</span>
                                <p class="font-medium">$${valorPedido.toLocaleString()}</p>
                            </div>
        
                            ${mostrarInputDomicilio ? `
                            <div class="col-span-2">
                                <label class="text-gray-600">Valor Domicilio:</label>
                                <input 
                                    type="number" 
                                    id="input-domicilio-${pedido._id}" 
                                    placeholder="Ingrese valor domicilio (0 si es gratis)" 
                                    class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:ring-purple-200"
                                    min="0"
                                    step="0.01"
                                    oninput="actualizarTotalEnVivo('${pedido._id}', ${valorPedido})"
                                />
                            </div>
                            ` : `
                            <div class="col-span-2">
                                <span class="text-gray-600">Valor Domicilio:</span>
                                <p class="font-medium">$${valorDomicilio.toLocaleString()}</p>
                            </div>
                            `}
        
                            <div class="col-span-2">
                                <span class="text-gray-600">Total:</span>
                                <p id="total-dinamico-${pedido._id}" class="text-lg font-bold text-green-600">$${valorTotal.toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
        
                    ${pedido.observacionGeneral ? `
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-yellow-800 mb-2">Observaci√≥n General</h4>
                        <p class="text-sm text-gray-700">"${pedido.observacionGeneral || ''}"</p>
                    </div>
                    ` : ''}
        
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="text-gray-600">Fecha:</span>
                                <p class="font-medium">${fechaFormateada}</p>
                            </div>
                            <div>
                                <span class="text-gray-600">Restaurante:</span>
                                <p class="font-medium">${pedido.extension || 'No especificado'}</p>
                            </div>
                        </div>
                    </div>
        
                    ${pedido.estado === 'pendiente' ? `
                    <div class="bg-purple-50 p-4 rounded-lg space-y-3">
                        <button onclick="aceptarPedido('${pedido._id}')" 
                            class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-check mr-1"></i> Aceptar
                        </button>
                        <button onclick="rechazarPedido('${pedido._id}')" 
                            class="w-full bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm">
                            <i class="fas fa-times mr-1"></i> Rechazar
                        </button>
                    </div>` : ''}
                </div>
            `;
        
            modal.classList.remove('hidden');
        }
        function actualizarTotalEnVivo(pedidoId, valorPedido) {
            const input = document.getElementById(`input-domicilio-${pedidoId}`);
            const total = document.getElementById(`total-dinamico-${pedidoId}`);
            let valorDomicilio = parseFloat(input.value) || 0;
            total.innerText = `$${(valorPedido + valorDomicilio).toLocaleString()}`;
        }
                
        function imprimirTicket(pedidoId) {
          window.open(`/facturas/${pedidoId}/ticket`, '_blank');
        }
        
        function cerrarModal() {
            document.getElementById('modal-detalles').classList.add('hidden');
        }
        
        function actualizarDatos() {
            const boton = event.target;
            const originalText = boton.innerHTML;
            
            boton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
            boton.disabled = true;
            
            cargarDatosIniciales().finally(() => {
                boton.innerHTML = originalText;
                boton.disabled = false;
            });
        }
        
        function mostrarMensaje(mensaje, tipo = 'info') {
            const notificacion = document.createElement('div');
            notificacion.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-semibold z-50 transition-transform transform translate-x-0 ${
                tipo === 'error' ? 'bg-red-500' : 
                tipo === 'success' ? 'bg-green-500' : 'bg-blue-500'
            }`;
            notificacion.textContent = mensaje;
            notificacion.style.transform = 'translateX(100%)';
            
            document.body.appendChild(notificacion);
            
            setTimeout(() => {
                notificacion.style.transform = 'translateX(0)';
            }, 10);
            
            setTimeout(() => {
                notificacion.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    notificacion.remove();
                }, 300);
            }, 3000);
        }
        
        function mostrarError(mensaje) {
            console.error(mensaje);
            mostrarMensaje(mensaje, 'error');
        }
        
        document.getElementById('form-cambiar-token').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const passwordActual = document.getElementById('token-actual').value;
            const passwordNuevo = document.getElementById('token-nuevo').value;
            const passwordConfirmar = document.getElementById('token-confirmar').value;

            if (passwordNuevo !== passwordConfirmar) {
                mostrarError('Las nuevas contrase√±as no coinciden.');
                return;
            }

            mostrarLoading(true);
            try {
                const response = await fetch('/admin/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        passwordActual,
                        passwordNuevo
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    mostrarMensaje('Contrase√±a actualizada correctamente.', 'success');
                    document.getElementById('form-cambiar-token').reset();
                } else {
                    throw new Error(data.error || 'No se pudo cambiar la contrase√±a.');
                }
            } catch (error) {
                mostrarError(error.message);
            } finally {
                mostrarLoading(false);
            }
        });
    </script>
</body>
</html>